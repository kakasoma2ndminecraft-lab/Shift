<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shift â€” Demo</title>
<style>
  :root{
    --bg:#f6f8fa; --card:#fff; --accent:#3e5f7a; --muted:#7a8b98;
    --gap:18px; font-family: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%; margin:0; background:var(--bg); color:#111;}
  .app{max-width:1000px; margin:20px auto; padding:24px; display:grid; gap:var(--gap);}
  .splash{display:flex;align-items:center;justify-content:center; gap:12px; padding:40px; background:linear-gradient(180deg,#eef4f8,#fff); border-radius:12px;}
  .splash h1{margin:0; color:var(--accent); letter-spacing:0.6px;}
  .row{display:flex; gap:12px; align-items:center;}
  .card{background:var(--card); border-radius:12px; padding:16px; box-shadow:0 6px 18px rgba(30,40,50,0.06);}
  .balance{display:flex; justify-content:space-between; align-items:center;}
  .balance .amount{font-size:28px; font-weight:700; color:var(--accent);}
  .missions, .store, .history{display:grid; gap:12px;}
  .mission-item{display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:10px; background:linear-gradient(90deg,#fff,#fbfdff);}
  .store-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:12px;}
  .product{padding:12px; border-radius:10px; text-align:center; cursor:pointer;}
  .product .emoji{font-size:36px;}
  .btn{background:var(--accent); color:#fff; padding:8px 12px; border-radius:8px; border:none; cursor:pointer;}
  .muted{color:var(--muted); font-size:13px;}
  .top-actions{display:flex; gap:8px;}
  .send-form{display:flex; gap:8px; align-items:center;}
  .send-form input{padding:8px; border-radius:8px; border:1px solid #e1e6ea;}
  footer{margin-top:12px; text-align:center; color:var(--muted); font-size:13px;}
  /* responsive tweaks */
  @media(min-width:900px){
    .app{grid-template-columns: 2fr 1fr; align-items:start;}
    .right-col{display:flex; flex-direction:column; gap:12px;}
  }
</style>
</head>
<body>
<main class="app" id="app">
  <section class="card splash" aria-hidden="false">
    <div>
      <h1>Shift</h1>
      <div class="muted">å­¦æ ¡ã®ãŸã‚ã®é™ã‹ãªçµŒæ¸ˆ â€” ãƒ‡ãƒ¢</div>
    </div>
    <div style="margin-left:auto; text-align:right;">
      <div class="muted">Signed in as</div>
      <strong id="username">ç”°ä¸­ å¤ªéƒ</strong>
    </div>
  </section>

  <section class="card">
    <div class="balance">
      <div>
        <div class="muted">HARUã‚³ã‚¤ãƒ³æ®‹é«˜</div>
        <div class="amount" id="balance">1,200</div>
      </div>
      <div class="top-actions">
        <button class="btn" id="btn-refresh">åŒæœŸ</button>
        <button class="btn" id="btn-open-send">é€ã‚‹</button>
      </div>
    </div>

    <hr style="margin:12px 0; border:none; border-top:1px solid #eef3f6;">

    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0">ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³</h3>
        <div class="muted">ç°¡å˜ã«ç¨¼ã’ã‚‹</div>
      </div>

      <div class="missions" id="missions" style="margin-top:12px;">
        <!-- mission items -->
      </div>
    </div>

    <hr style="margin:12px 0; border:none; border-top:1px solid #eef3f6;">

    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0">ã‚¹ãƒˆã‚¢</h3>
        <div class="muted">HARUã‚³ã‚¤ãƒ³ã§è³¼å…¥</div>
      </div>
      <div class="store-grid" id="store" style="margin-top:12px;">
        <!-- products -->
      </div>
    </div>
  </section>

  <aside class="right-col">
    <section class="card">
      <h4 style="margin:0 0 8px 0">é€é‡‘ï¼ˆQR or æ¤œç´¢ï¼‰</h4>
      <div class="send-form">
        <input id="send-to" placeholder="ç›¸æ‰‹ã®åå‰ or id" />
        <input id="send-amount" placeholder="é‡‘é¡" type="number" />
        <button class="btn" id="send-btn">é€é‡‘</button>
      </div>
      <div id="send-msg" class="muted" style="margin-top:8px;"></div>
    </section>

    <section class="card">
      <h4 style="margin:0 0 8px 0">æœ€è¿‘ã®å±¥æ­´</h4>
      <div id="history" class="history muted" style="max-height:240px; overflow:auto;">
        <!-- history items -->
      </div>
    </section>
  </aside>

  <footer>ã“ã‚Œã¯ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ã™ã€‚å®Ÿéš›ã®é‹ç”¨ã§ã¯èªè¨¼ãƒ»ç›£æŸ»ãŒå¿…é ˆã€‚</footer>
</main>

<script>
/*
 Simple demo logic.
 - No backend. Demonstrates client flows, idempotency key usage example, and offline queue.
 - Replace with real API calls in production.
*/

const state = {
  user: { id: "u_123", name:"ç”°ä¸­ å¤ªéƒ", balance:1200 },
  missions: [
    {id:"m1", description:"æœã®èª­æ›¸30åˆ†", reward:50, status:"open"},
    {id:"m2", description:"æå‡ºç‰©ã‚’å‡ºã™", reward:30, status:"open"}
  ],
  products: [
    {id:"p1", title:"å›³æ›¸åˆ¸", price:500, emoji:"ğŸ“š", stock:5},
    {id:"p2", title:"ãŠã‚„ã¤åˆ¸", price:100, emoji:"ğŸª", stock:20},
    {id:"p3", title:"å›³æ›¸é¤¨å„ªå…ˆäºˆç´„", price:200, emoji:"ğŸ«", stock:3}
  ],
  history: []
};

function fmt(n){ return n.toLocaleString(); }

function render(){
  document.getElementById('username').textContent = state.user.name;
  document.getElementById('balance').textContent = fmt(state.user.balance);
  // missions
  const missionsEl = document.getElementById('missions');
  missionsEl.innerHTML = '';
  state.missions.forEach(m=>{
    const div = document.createElement('div');
    div.className = 'mission-item';
    div.innerHTML = `<div><strong>${m.description}</strong><div class="muted">å ±é…¬ ${m.reward} ã‚³ã‚¤ãƒ³</div></div>
    <div><button class="btn" data-id="${m.id}">å®Œäº†ç”³è«‹</button></div>`;
    missionsEl.appendChild(div);
  });

  // products
  const store = document.getElementById('store');
  store.innerHTML = '';
  state.products.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'product card';
    el.innerHTML = `<div class="emoji">${p.emoji}</div><div style="margin-top:8px"><strong>${p.title}</strong></div>
    <div class="muted">ä¾¡æ ¼ ${p.price}</div>`;
    el.addEventListener('click', ()=>purchase(p.id));
    store.appendChild(el);
  });

  // history
  const hist = document.getElementById('history');
  hist.innerHTML = '';
  state.history.slice().reverse().forEach(t=>{
    const item = document.createElement('div');
    item.style.padding='8px';
    item.style.borderBottom='1px solid #f1f5f8';
    item.innerHTML = `<div style="font-weight:600">${t.summary}</div><div class="muted">${new Date(t.timestamp).toLocaleString()}</div>`;
    hist.appendChild(item);
  });
}

function addHistory(summary){
  state.history.push({ summary, timestamp: Date.now() });
  render();
}

// idempotency key example
function makeIdem(){ return 'idem_'+Date.now()+'_'+Math.random().toString(36).slice(2,8); }

// Simulated server-side transaction commit
function commitTransaction(tx){
  // optimistic local apply
  if(tx.type === 'transfer' || tx.type === 'purchase' || tx.type === 'mission_reward'){
    state.user.balance -= tx.amount;
  } else if(tx.type === 'mint'){
    state.user.balance += tx.amount;
  }
  addHistory(`${tx.type} ${tx.amount} ã‚³ã‚¤ãƒ³ (${tx.meta?.note || ''})`);
}

// UI actions
document.getElementById('btn-refresh').addEventListener('click', ()=>{
  // in real app: GET /sync/changes?since=...
  alert('åŒæœŸã‚’æ¨¡æ“¬ã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ¢ï¼‰');
});

document.getElementById('send-btn').addEventListener('click', ()=>{
  const to = document.getElementById('send-to').value.trim();
  const amt = Number(document.getElementById('send-amount').value);
  const msg = document.getElementById('send-msg');
  if(!to || !amt || amt<=0){ msg.textContent = 'ç›¸æ‰‹ã¨é‡‘é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'; return; }
  if(amt > state.user.balance){ msg.textContent = 'æ®‹é«˜ä¸è¶³ã§ã™ã€‚'; return; }
  const tx = { idempotency_key: makeIdem(), type:'transfer', from:state.user.id, to, amount:amt, meta:{note:`é€é‡‘ to ${to}`} };
  commitTransaction(tx);
  msg.textContent = `é€é‡‘æ¸ˆã¿ (${amt} ã‚³ã‚¤ãƒ³)ã€‚id=${tx.idempotency_key}`;
});

document.getElementById('app').addEventListener('click', (e)=>{
  if(e.target.matches('.mission-item .btn') || e.target.closest('.mission-item .btn')){
    const id = e.target.dataset.id;
    claimMission(id);
  }
});

function claimMission(id){
  const m = state.missions.find(x=>x.id===id);
  if(!m) return;
  // create claim â€” in real app: POST /missions/:id/claim
  // Here we simulate teacher auto-approval for demo
  const idem = makeIdem();
  // server approves and issues reward
  const tx = { idempotency_key: idem, type:'mission_reward', from:'system', to:state.user.id, amount:m.reward, meta:{note:`ãƒŸãƒƒã‚·ãƒ§ãƒ³å ±é…¬ ${m.description}`} };
  // apply
  // mission reward increases balance
  state.user.balance += tx.amount;
  addHistory(`ãƒŸãƒƒã‚·ãƒ§ãƒ³æ‰¿èª: +${tx.amount} (${m.description})`);
  render();
}

function purchase(productId){
  const p = state.products.find(x=>x.id===productId);
  if(!p) return;
  if(p.price > state.user.balance){ alert('æ®‹é«˜ä¸è¶³ã§ã™'); return; }
  const idem = makeIdem();
  // in real: POST /products/:id/purchase { idempotency_key }
  // simulate server commit
  commitTransaction({ idempotency_key: idem, type:'purchase', from:state.user.id, to:p.seller || 'school', amount:p.price, meta:{product_id:p.id, note:p.title} });
  // reduce stock
  p.stock = Math.max(0, (p.stock||1)-1);
  render();
}

// initial render
render();
</script>
</body>
</html>
